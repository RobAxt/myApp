name: ESP-IDF CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-qemu:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:release-v6.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run Unity tests in QEMU (custom script)
        shell: bash
        working-directory: test
        env:
          IDF_TIMEOUT: 300
        run: |
          set -e
          . "$IDF_PATH/export.sh"
          # Lanzar QEMU y guardar el PID real
          (idf.py qemu 2>&1 | tee output.log) &
          QEMU_PID=$!

          # Espera a que aparezca "Returned from app_main" en el log, chequeando cada segundo
          FOUND=0
          for i in $(seq 1 ${IDF_TIMEOUT}); do
            if grep -q "Returned from app_main" output.log; then
              FOUND=1
              echo "Tests finalizados, matando QEMU..."
              if kill -0 $QEMU_PID 2>/dev/null; then
                kill $QEMU_PID
              else
                echo "QEMU ya terminó antes de kill."
              fi
              break
            fi
            sleep 1
          done

          if [ $FOUND -eq 0 ]; then
            echo "No se encontró 'Returned from app_main' en el log tras ${IDF_TIMEOUT} segundos."
            # Opcional: matar QEMU si sigue vivo
            if kill -0 $QEMU_PID 2>/dev/null; then
              kill $QEMU_PID
            fi
          fi

          # Espera que QEMU termine, ignorando exit code 143 (SIGTERM)
          wait $QEMU_PID || EXIT_CODE=$?
          if [ "${EXIT_CODE}" = "143" ]; then
            echo "QEMU terminado por kill (SIGTERM), esto es esperado."
          elif [ -n "${EXIT_CODE}" ] && [ "${EXIT_CODE}" != "0" ]; then
            exit ${EXIT_CODE}
          fi

      - name: Upload QEMU logs
        uses: actions/upload-artifact@v4
        with:
          name: qemu-logs
          path: test/output.log
