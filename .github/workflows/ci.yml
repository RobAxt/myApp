name: ESP-IDF CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    container:
      image: espressif/idf:release-v6.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show ESP-IDF version
        shell: bash
        run: |
          echo "IDF_PATH = $IDF_PATH"
          . "$IDF_PATH/export.sh"
          idf.py --version

      - name: Configure project (cmake)
        shell: bash
        run: |
          . "$IDF_PATH/export.sh"
          idf.py reconfigure

      - name: Build firmware
        shell: bash
        run: |
          . "$IDF_PATH/export.sh"
          idf.py build

      - name: Run Unity tests in QEMU
        shell: bash
        run: |
          set -e
          . "$IDF_PATH/export.sh"

          cd build

          # 1) Generar imagen de flash a partir de los binarios (usa @flash_args generado por idf.py)
          esptool.py --chip esp32 merge_bin --fill-flash-size 4MB -o flash_image.bin @flash_args

          # 2) Ejecutar QEMU. 
          #    -nographic → saca todo por stdout
          #    -no-reboot → cuando termina, QEMU sale
          #    -serial file:output.log → log de la UART a archivo
          qemu-system-xtensa \
            -nographic \
            -no-reboot \
            -machine esp32 \
            -drive file=flash_image.bin,if=mtd,format=raw \
            -serial file:output.log

          echo "========== QEMU / Unity log =========="
          cat output.log

          # 3) Si Unity dejó alguna línea con FAIL, hacer fallar el job
          if grep -q "FAIL" output.log; then
            echo "❌ Algunos tests de Unity FALLARON"
            exit 1
          fi

          echo "✅ Todos los tests pasaron (no se encontró 'FAIL' en el log)"
